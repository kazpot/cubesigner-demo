<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="../node_modules/mermaid/dist/mermaid.min.js"></script>
    <script>
      mermaid.initialize({ startOnLoad: true });
    </script>
  </head>
  <body>
    <div class="mermaid">
    sequenceDiagram
      participant seller as Seller
      participant buyer as Buyer
      participant oidc as Google
      participant resella as Resella API
      participant cube as CubeSigner
      participant relayer as Gas Relayer
      participant blockchain as Blockchain
      participant mp as Marketplace Contract
      participant webhook as Webhook Server
      participant db as Resella DB
      
      seller ->> seller: 1. check token existence and expiration
      seller ->> oidc: 2. if token is invalid, generate OIDC token again
      oidc ->> seller: 3. callback with a new OIDC token
      seller ->> seller: 4. FIDO/TOTP (if MFA was set during registration)
      
      seller ->> cube: 5. sessionCreate (Exchange OIDC token for signer session)
      cube -->> seller: signer session
      seller ->> resella: 6. 所持NFT一覧取得
      resella -->> seller: 所持NFT一覧
      seller ->> blockchain: 7. getTransactionCount
      blockchain --> seller: nonce
      seller ->> cube: 8. createListingメソッドに対してEIP712 sign request (Gas less transaction)
      cube -->> seller: signed transaction
      seller ->> relayer: 9. sendRawTransaction
      relayer ->> blockchain: foward
      blockchain ->> mp: createListingメソッド実行
      mp ->> webhook: ListingAddedイベント
      webhook ->> db: Listレコード新規追加
      mp -->> blockchain: ok
      blockchain -->> relayer: ok
      relayer -->> seller: ok

      buyer ->> buyer: 10. check token existence and expiration
      buyer ->> oidc: 11. if token is invalid, generate OIDC token again
      oidc ->> buyer: 12. callback with a new OIDC token
      buyer ->> buyer: 13. FIDO/TOTP (if MFA was set during registration)
      buyer ->> cube: 14. sessionCreate (Exchange OIDC token for signer session)
      cube -->> buyer: signer session
      buyer ->> resella: 15. 出品中NFT一覧取得
      resella ->> db: 出品中NFT一覧取得
      db -->> resella: 出品中NFT一覧
      resella -->> buyer: 出品中NFT一覧
      buyer ->> blockchain: 16. getTransactionCount
      blockchain --> buyer: nonce
      buyer ->> cube: 17. buyメソッドに対してEIP712 sign request (Gas less transaction)
      cube -->> buyer: signed transaction
      buyer ->> relayer: 18. sendRawTransaction
      relayer ->> blockchain: foward
      blockchain ->> mp: buyメソッド実行
      mp ->> mp: buyerからsellerに支払い
      mp ->> mp: 支払い完了後sellerからbuyerにNFTを転送
      mp ->> webhook: NewSaleイベント
      webhook ->> db: Listingレコード更新
      mp -->> blockchain: ok
      blockchain -->> relayer: ok
      relayer -->> buyer: ok
    </div>
  </body>
</html>
